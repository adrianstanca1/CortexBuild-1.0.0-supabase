import{r as e,j as t}from"./react-core-FGHlRSau.js";import{F as s,K as l,ak as a,M as n,al as r,am as o,an as i,n as c,ao as d}from"./module-screens-Dy02k3Q1.js";import"./vendor-BX0gT1qP.js";import"./google-ai-BrP-uSwO.js";import"./developer-tools-B-VjJpHg.js";import"./supabase-DKHGIEFa.js";import"./axios-ei4kQ0Q2.js";import"./icon-pack-tZfEXMDa.js";import"./monaco-Bh77eHRb.js";const x="#3b82f6",u="#ef4444",h=({project:h,goBack:m,url:f,title:p})=>{const y=e.useRef(null),g=e.useRef(null),b=e.useRef(null),[j,k]=e.useState(null),[w,v]=e.useState(1),[N,S]=e.useState(0),[M,C]=e.useState(1.5),[P,R]=e.useState([]),[D,E]=e.useState([]),[L,$]=e.useState("select"),[T,B]=e.useState(!1),[I,z]=e.useState(null),[W,A]=e.useState(null),[O,G]=e.useState(!1),[J,Y]=e.useState(null),[_,q]=e.useState(null),[F,K]=e.useState(null),[U,V]=e.useState(""),[X,H]=e.useState(u),Q=[{hex:u,name:"Red"},{hex:"#3b82f6",name:"Blue"},{hex:"#22c55e",name:"Green"},{hex:"#eab308",name:"Yellow"}];e.useEffect(()=>{"undefined"!=typeof pdfjsLib&&(pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.107/pdf.worker.min.js")},[]);const Z=e.useCallback(()=>`markups_${h.id}_${f}`,[h.id,f]);e.useEffect(()=>{if(!f||"undefined"==typeof pdfjsLib)return;k(null),v(1),S(0),A(null);const e=Z();try{const t=localStorage.getItem(e);if(t){const{pins:e=[],markups:s=[]}=JSON.parse(t);R(e.map(e=>({...e,id:e.id||`pin-${Math.random()}`,color:e.color||u}))),E(s.map(e=>({...e,id:e.id||`markup-${Math.random()}`,color:e.color||u})))}else R([]),E([])}catch(t){R([]),E([])}pdfjsLib.getDocument(f).promise.then(e=>{k(e),S(e.numPages)}).catch(console.error)},[f,h.id,Z]),e.useEffect(()=>{if(!f||!j)return;const e=Z();try{const t=JSON.stringify({pins:P,markups:D});localStorage.setItem(e,t)}catch(t){}},[P,D,j,Z]),e.useEffect(()=>{const e=e=>{"Delete"!==e.key&&"Backspace"!==e.key||!W||("x"in W?R(e=>e.filter(e=>e.id!==W.id)):E(e=>e.filter(e=>e.id!==W.id)),A(null))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[W]);const ee=(e,t)=>{e.fillStyle=t.color,e.beginPath(),e.arc(t.x,t.y,8,0,2*Math.PI),e.fill(),t.note&&(e.fillStyle="#3b82f6",e.beginPath(),e.arc(t.x,t.y-8-3,3,0,2*Math.PI),e.fill())},te=e.useCallback(()=>{const e=g.current,t=e?.getContext("2d");t&&e&&(t.clearRect(0,0,e.width,e.height),D.filter(e=>e.page===w).forEach(e=>{t.strokeStyle=e.color,t.lineWidth=3,"line"===e.type?(t.beginPath(),t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.stroke()):"rectangle"===e.type&&t.strokeRect(e.start.x,e.start.y,e.end.x-e.start.x,e.end.y-e.start.y)}),P.filter(e=>e.page===w).forEach(e=>{ee(t,e)}),W&&W.page===w&&((e,t)=>{if(e.fillStyle=x,e.strokeStyle=x,e.lineWidth=2,e.setLineDash([6,3]),"x"in t)e.beginPath(),e.arc(t.x,t.y,12,0,2*Math.PI),e.stroke();else{const s=Math.min(t.start.x,t.end.x),l=Math.min(t.start.y,t.end.y),a=Math.max(t.start.x,t.end.x),n=Math.max(t.start.y,t.end.y);e.strokeRect(s-5,l-5,a-s+10,n-l+10),e.setLineDash([]),e.fillRect(t.start.x-4,t.start.y-4,8,8),e.fillRect(t.end.x-4,t.end.y-4,8,8)}e.setLineDash([])})(t,W))},[D,P,w,W]),se=e.useCallback(async e=>{if(!j)return;const t=await j.getPage(e),s=t.getViewport({scale:M}),l=y.current,a=g.current;if(l&&a){l.height=s.height,l.width=s.width,a.height=s.height,a.width=s.width;const e={canvasContext:l.getContext("2d"),viewport:s};await t.render(e).promise,te()}},[j,M,te]);e.useEffect(()=>{j&&se(w)},[j,w,M,se]);const le=e=>{const t=g.current;if(!t)return{x:0,y:0};const s=t.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}},ae=(e,t,s=10)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))<s;e.useEffect(()=>{F&&b.current&&b.current.focus()},[F]);const ne=({tool:e,label:s,icon:l,tooltip:a})=>t.jsxs("button",{onClick:()=>$(e),title:a,"aria-label":a,className:"p-2 rounded-lg flex flex-col items-center text-xs w-16 transition-colors "+(L===e?"bg-blue-600 text-white":"hover:bg-slate-700"),children:[t.jsx(l,{className:"w-5 h-5 mb-1"}),s]});return t.jsxs("div",{className:"flex flex-col h-[calc(100vh-10rem)] bg-slate-800 text-white rounded-lg overflow-hidden select-none",children:[t.jsxs("header",{className:"bg-slate-900/80 p-4 flex justify-between items-center z-20 border-b border-slate-700",children:[t.jsx("button",{onClick:m,className:"p-2 rounded-full hover:bg-slate-700",children:t.jsx(s,{className:"w-6 h-6"})}),t.jsxs("div",{className:"text-center",children:[t.jsx("h1",{className:"text-xl font-bold truncate",children:p||"Plan"}),t.jsx("p",{className:"text-sm text-slate-400",children:h.name})]}),t.jsx("div",{className:"w-10",children:W&&"select"===L&&t.jsx("button",{onClick:()=>{"x"in W?R(e=>e.filter(e=>e.id!==W.id)):E(e=>e.filter(e=>e.id!==W.id)),A(null)},className:"p-2 rounded-full bg-red-500/50 hover:bg-red-500",title:"Delete Selected Markup (Del/Backspace)",children:t.jsx(l,{className:"w-6 h-6"})})})]}),t.jsxs("div",{className:"bg-slate-900/80 p-2 flex justify-center items-center z-20 border-b border-slate-700 gap-4",children:[t.jsxs("div",{className:"flex items-center gap-1 p-2 rounded-lg bg-slate-800/50",children:[t.jsx(ne,{tool:"select",label:"Select",icon:a,tooltip:"Select, move, and edit markups"}),t.jsx("div",{className:"w-px h-10 bg-slate-700 mx-1"}),t.jsx(ne,{tool:"pin",label:"Pin",icon:n,tooltip:"Add a pin markup"}),t.jsx(ne,{tool:"line",label:"Line",icon:r,tooltip:"Draw a line markup"}),t.jsx(ne,{tool:"rectangle",label:"Rect",icon:o,tooltip:"Draw a rectangle markup"})]}),t.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-slate-800/50",children:[t.jsx("span",{className:"text-sm font-medium text-slate-400 select-none",children:"Color:"}),t.jsx("div",{className:"flex items-center gap-2",children:Q.map(e=>t.jsx("button",{onClick:()=>H(e.hex),className:"w-7 h-7 rounded-full transition-all "+(X===e.hex?"ring-2 ring-white ring-offset-2 ring-offset-slate-800":"hover:opacity-80"),style:{backgroundColor:e.hex},title:`Set color to ${e.name}`,"aria-label":`Select color ${e.name}`},e.hex))})]})]}),t.jsxs("main",{className:"flex-grow overflow-auto flex items-start justify-center p-4 relative",children:[t.jsxs("div",{className:"relative",children:[t.jsx("canvas",{ref:y}),t.jsx("canvas",{ref:g,className:"absolute top-0 left-0",onMouseDown:e=>{const t=le(e);if("select"===L){const e=P.find(e=>e.page===w&&ae(t,e,13)),s=e?void 0:[...D].reverse().find(e=>{if(e.page!==w)return!1;const s=Math.min(e.start.x,e.end.x)-5,l=Math.min(e.start.y,e.end.y)-5,a=Math.max(e.start.x,e.end.x)+5,n=Math.max(e.start.y,e.end.y)+5;return t.x>=s&&t.x<=a&&t.y>=l&&t.y<=n}),l=e||s;if(l){if(A(l),!("x"in l)){if(ae(t,l.start,8))return q("start"),B(!0),void z(l.end);if(ae(t,l.end,8))return q("end"),B(!0),void z(l.start)}G(!0),Y(t)}else A(null)}else if("pin"===L){const e={id:`pin-${Date.now()}`,...t,page:w,color:X};R(t=>[...t,e])}else B(!0),z(t)},onMouseMove:e=>{if(!T&&!O)return;const t=le(e);te();const s=g.current,l=s?.getContext("2d");if(l)if(l.lineWidth=3,T&&I){let e=X;_&&W&&!("x"in W)&&(e=W.color),l.strokeStyle=e,"line"===L||_&&W&&!("x"in W)&&"line"===W.type?(l.beginPath(),l.moveTo(I.x,I.y),l.lineTo(t.x,t.y),l.stroke()):("rectangle"===L||_&&W&&!("x"in W)&&"rectangle"===W.type)&&l.strokeRect(I.x,I.y,t.x-I.x,t.y-I.y)}else if(O&&W&&J){const e=t.x-J.x,s=t.y-J.y;l.globalAlpha=.5,"x"in W?ee(l,{...W,x:W.x+e,y:W.y+s}):(l.strokeStyle=W.color,"line"===W.type?(l.beginPath(),l.moveTo(W.start.x+e,W.start.y+s),l.lineTo(W.end.x+e,W.end.y+s),l.stroke()):"rectangle"===W.type&&l.strokeRect(W.start.x+e,W.start.y+s,W.end.x-W.start.x,W.end.y-W.start.y)),l.globalAlpha=1}},onMouseUp:e=>{const t=le(e);if(T){if(_&&W&&I&&!("x"in W)){let e=null;const s=D.map(s=>{if(s.id===W.id){let l="start"===_?t:I,a="end"===_?t:I;return"rectangle"===s.type&&(l={x:Math.min(l.x,a.x),y:Math.min(l.y,a.y)},a={x:Math.max(l.x,a.x),y:Math.max(l.y,a.y)}),e={...s,start:l,end:a},e}return s});E(s),e&&A(e)}else if(I&&("line"===L||"rectangle"===L)){let e=I,s=t;"rectangle"===L&&(e={x:Math.min(I.x,t.x),y:Math.min(I.y,t.y)},s={x:Math.max(I.x,t.x),y:Math.max(I.y,t.y)});const l={id:`markup-${Date.now()}`,type:L,start:e,end:s,page:w,color:X};E(e=>[...e,l])}}else if(O&&W&&J){const e=t.x-J.x,s=t.y-J.y;if("x"in W){let t=null;const l=P.map(l=>l.id===W.id?(t={...l,x:l.x+e,y:l.y+s},t):l);R(l),t&&A(t)}else{let t=null;const l=D.map(l=>l.id===W.id?(t={...l,start:{x:l.start.x+e,y:l.start.y+s},end:{x:l.end.x+e,y:l.end.y+s}},t):l);E(l),t&&A(t)}}else if("select"===L&&J&&ae(J,t,5)){const e=P.find(e=>e.page===w&&ae(t,e));e&&e.id===W?.id&&(K(e),V(e.note||""))}B(!1),z(null),G(!1),Y(null),q(null)},style:{cursor:"select"===L?"default":"crosshair"}})]}),F&&t.jsxs("div",{className:"absolute top-4 right-4 bg-slate-700 rounded-lg shadow-2xl p-4 w-64 z-30",onClick:e=>e.stopPropagation(),children:[t.jsx("h3",{className:"text-lg font-bold mb-2",children:"Note for Pin"}),t.jsx("textarea",{ref:b,value:U,onChange:e=>V(e.target.value),rows:4,className:"w-full p-2 rounded bg-slate-800 text-white border border-slate-600 focus:ring-blue-500 focus:border-blue-500"}),t.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[t.jsx("button",{onClick:()=>K(null),className:"px-3 py-1 rounded bg-slate-600 hover:bg-slate-500 text-sm",children:"Cancel"}),t.jsx("button",{onClick:()=>{F&&(R(e=>e.map(e=>e.id===F.id?{...e,note:U}:e)),K(null),V(""))},className:"px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-sm font-bold",children:"Save"})]})]})]}),t.jsxs("footer",{className:"bg-slate-900/80 p-2 flex justify-center items-center z-20 border-t border-slate-700 space-x-4",children:[t.jsx("button",{onClick:()=>C(e=>Math.max(e-.2,.5)),className:"p-2 rounded-full hover:bg-slate-700",children:t.jsx(i,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("button",{onClick:()=>{w>1&&(A(null),v(e=>e-1))},disabled:w<=1,className:"p-2 rounded-full hover:bg-slate-700 disabled:opacity-50",children:t.jsx(s,{className:"w-6 h-6"})}),t.jsxs("span",{className:"w-20 text-center",children:["Page ",w," / ",N]}),t.jsx("button",{onClick:()=>{w<N&&(A(null),v(e=>e+1))},disabled:w>=N,className:"p-2 rounded-full hover:bg-slate-700 disabled:opacity-50",children:t.jsx(c,{className:"w-6 h-6"})})]}),t.jsx("button",{onClick:()=>C(e=>Math.min(e+.2,3)),className:"p-2 rounded-full hover:bg-slate-700",children:t.jsx(d,{className:"w-6 h-6"})})]})]})};export{h as default};
