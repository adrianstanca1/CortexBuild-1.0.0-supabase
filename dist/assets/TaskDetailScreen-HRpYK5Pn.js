import{r as e,j as s}from"./react-core-FGHlRSau.js";import{F as t,t as a,U as r,E as l,P as n,K as o,N as i,O as d,R as c,V as m}from"./module-screens-Dy02k3Q1.js";import{P as x}from"./PhotoLightbox-C62kCQiO.js";import"./vendor-BX0gT1qP.js";import"./google-ai-BrP-uSwO.js";import"./developer-tools-B-VjJpHg.js";import"./supabase-DKHGIEFa.js";import"./axios-ei4kQ0Q2.js";import"./icon-pack-tZfEXMDa.js";import"./monaco-Bh77eHRb.js";const h=e=>{if(e.assignee)return e.assignee;if(e.targetRoles&&e.targetRoles.length>0){return`All ${e.targetRoles[0]}s`}return"Unassigned"},g=e=>{switch(e){case"High":return"bg-red-100 text-red-800";case"Medium":return"bg-yellow-100 text-yellow-800";case"Low":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}},p=e=>/\.(jpeg|jpg|gif|png|webp)$/i.test(e.name)||e.url.startsWith("data:image"),u=({taskId:u,project:j,goBack:b,currentUser:f,can:y})=>{const[N,v]=e.useState(null),[w,D]=e.useState(!0),[k,P]=e.useState(""),[S,C]=e.useState([]),[A,L]=e.useState(!1),[R,T]=e.useState(!1),[F,U]=e.useState(0);e.useEffect(()=>{(async()=>{D(!0);const e=await d(u);v(e||null),D(!1)})()},[u]);const I=e=>{e&&C(s=>[...s,...Array.from(e)])},E=e.useMemo(()=>N?.attachments.filter(p)||[],[N]),H=E.map(e=>({url:e.url,caption:e.name}));if(w)return s.jsx("div",{className:"text-center p-8",children:"Loading task details..."});if(!N)return s.jsx("div",{className:"text-center p-8 text-red-500",children:"Task not found."});const O=(e=>{if("Done"===e.status)return!1;const s=new Date;return s.setHours(0,0,0,0),new Date(e.dueDate)<s})(N),$=y("update","task");return s.jsxs("div",{className:"flex flex-col h-full max-w-4xl mx-auto",children:[s.jsxs("header",{className:"bg-white p-4 flex items-center border-b mb-8",children:[s.jsx("button",{onClick:b,className:"mr-4 p-2 rounded-full hover:bg-gray-100",children:s.jsx(t,{className:"w-6 h-6 text-gray-600"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900 truncate",title:N.title,children:N.title}),s.jsx("p",{className:"text-sm text-gray-500",children:j.name})]})]}),s.jsxs("main",{className:"flex-grow space-y-6",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-100 p-6 grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Description"}),s.jsx("p",{className:"text-gray-600 whitespace-pre-wrap",children:N.description||"No description provided."})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Status"}),s.jsxs("select",{value:N.status,onChange:async e=>{if(!N)return;const s=e.target.value,t={...N,status:s};v(t);try{const e=await c(t,f);v(e)}catch(a){alert(a.message);const e=await d(u);v(e||null)}},className:"w-full mt-1 p-2 border border-gray-300 rounded-md disabled:opacity-70 disabled:bg-gray-100 disabled:cursor-not-allowed",disabled:!$,children:[s.jsx("option",{value:"To Do",disabled:"Foreman"===f.role||"operative"===f.role,children:"To Do"}),s.jsx("option",{value:"In Progress",children:"In Progress"}),s.jsx("option",{value:"Done",children:"Done"})]})]}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1.5",children:[s.jsx(a,{className:"w-4 h-4"}),"Priority"]}),s.jsx("span",{className:`font-semibold inline-block px-2 py-0.5 text-xs rounded-full ${g(N.priority)}`,children:N.priority})]}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1.5",children:[s.jsx(r,{className:"w-4 h-4"}),"Assignee"]}),s.jsx("p",{className:"text-gray-800 font-semibold",children:h(N)})]}),s.jsxs("div",{children:[s.jsxs("p",{className:"text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1.5 "+(O?"text-red-600":""),children:[s.jsx(l,{className:"w-4 h-4"}),"Due Date"]}),s.jsx("p",{className:"font-semibold "+(O?"text-red-600":"text-gray-800"),children:new Date(N.dueDate).toLocaleDateString()})]})]})]}),N.attachments&&N.attachments.length>0&&s.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-100 p-6",children:[s.jsxs("h3",{className:"font-bold text-lg text-gray-800 mb-2 flex items-center gap-2",children:[s.jsx(n,{className:"w-5 h-5"}),"Attachments"]}),s.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4",children:E.map((e,t)=>s.jsx("button",{onClick:()=>(e=>{U(e),T(!0)})(t),className:"block group relative focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md",children:s.jsx("img",{src:e.url,alt:e.name,className:"w-full h-24 object-cover rounded-md group-hover:opacity-80 transition-opacity"})},t))}),N.attachments.filter(e=>!p(e)).length>0&&s.jsxs("div",{className:"mt-4",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Other Files:"}),s.jsx("ul",{className:"mt-2 space-y-1",children:N.attachments.filter(e=>!p(e)).map((e,t)=>s.jsx("li",{children:s.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline",children:e.name})},t))})]})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-100 p-6",children:[s.jsxs("h3",{className:"font-bold text-lg text-gray-800 mb-4",children:["Comments (",N.comments.length,")"]}),s.jsx("div",{className:"space-y-4",children:N.comments.map(e=>s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 flex-shrink-0",children:e.author.charAt(0)}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-baseline gap-2",children:[s.jsx("p",{className:"font-bold text-sm",children:e.author}),s.jsx("p",{className:"text-xs text-gray-500",children:new Date(e.timestamp).toLocaleString()})]}),s.jsx("p",{className:"text-sm text-gray-700 mt-1 whitespace-pre-wrap",children:e.text}),e.attachments&&e.attachments.length>0&&s.jsxs("div",{className:"mt-2",children:[s.jsx("p",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Attachments:"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:e.attachments.map((e,t)=>s.jsxs("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-sm bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-md flex items-center gap-1.5",children:[s.jsx(n,{className:"w-4 h-4 text-gray-500"}),s.jsx("span",{className:"truncate max-w-xs",children:e.name})]},t))})]})]})]},e.id))}),s.jsxs("div",{className:"mt-6 pt-4 border-t",children:[s.jsx("textarea",{rows:3,value:k,onChange:e=>P(e.target.value),placeholder:"Add a comment...",className:"w-full p-2 border border-gray-300 rounded-md"}),s.jsxs("div",{className:"mt-2",children:[s.jsx("div",{onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),L(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),L(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{e.preventDefault(),e.stopPropagation(),L(!1),e.dataTransfer.files&&e.dataTransfer.files.length>0&&I(e.dataTransfer.files)},className:"mt-2 flex justify-center rounded-lg border border-dashed px-6 py-4 transition-colors "+(A?"border-blue-600 bg-blue-50":"border-gray-900/25"),children:s.jsxs("div",{className:"text-center",children:[s.jsx(n,{className:"mx-auto h-8 w-8 text-gray-300"}),s.jsxs("div",{className:"mt-2 flex text-sm text-gray-600",children:[s.jsxs("label",{htmlFor:"file-upload",className:"relative cursor-pointer rounded-md bg-white font-semibold text-blue-600 hover:text-blue-500",children:[s.jsx("span",{children:"Upload files"}),s.jsx("input",{id:"file-upload",type:"file",className:"sr-only",onChange:e=>{e.target.files&&I(e.target.files),e.target&&(e.target.value="")},multiple:!0})]}),s.jsx("p",{className:"pl-1",children:"or drag and drop"})]})]})}),S.length>0&&s.jsx("div",{className:"mt-2 space-y-2",children:S.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-100 rounded-md text-sm",children:[s.jsx("span",{className:"font-medium text-gray-700 truncate",children:e.name}),s.jsx("button",{onClick:()=>{return e=t,void C(s=>s.filter((s,t)=>t!==e));var e},className:"p-1 text-gray-400 hover:text-red-500",children:s.jsx(o,{className:"w-4 h-4"})})]},t))})]}),s.jsx("div",{className:"text-right mt-2",children:s.jsx("button",{onClick:async()=>{if(!N||!k.trim()&&0===S.length)return;const e=await Promise.all(S.map(e=>new Promise((s,t)=>{const a=new FileReader;a.onload=t=>{s({name:e.name,url:t.target?.result})},a.onerror=t,a.readAsDataURL(e)}))),s=await m(N.id,k,e,f);v(e=>e?{...e,comments:[...e.comments,s]}:null),P(""),C([])},className:"px-4 py-2 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700",children:"Post Comment"})})]})]}),N.history&&N.history.length>0&&s.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-100 p-6",children:[s.jsxs("h3",{className:"font-bold text-lg text-gray-800 mb-4 flex items-center gap-2",children:[s.jsx(i,{className:"w-5 h-5 text-gray-500"}),"History"]}),s.jsx("ul",{className:"space-y-4 border-l-2 border-gray-200 ml-2",children:N.history.slice().reverse().map((e,t)=>s.jsxs("li",{className:"relative pl-6",children:[s.jsx("div",{className:"absolute -left-[7px] top-1.5 w-3 h-3 bg-gray-300 rounded-full ring-4 ring-white"}),s.jsx("p",{className:"text-sm text-gray-800 font-medium",children:e.change}),s.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:["by ",e.author," Â· ",new Date(e.timestamp).toLocaleString()]})]},t))})]})]}),R&&s.jsx(x,{photos:H,startIndex:F,onClose:()=>T(!1)})]})};export{u as default};
